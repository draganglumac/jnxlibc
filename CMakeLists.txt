cmake_minimum_required(VERSION 2.8)
set(INSTALL_PREFIX /usr)
project(jnxlibc)

file(MAKE_DIRECTORY jnxc_headers)
file(GLOB HEADERS_CP "src/**/*.h")
file(GLOB RAW_SRC "src/**/*.c")
file(COPY ${HEADERS_CP} DESTINATION jnxc_headers)

add_subdirectory(src/alg)
add_subdirectory(src/dat)
add_subdirectory(src/io)
add_subdirectory(src/ipc)
add_subdirectory(src/net)
add_subdirectory(src/sig)
add_subdirectory(src/sys)
add_subdirectory(src/thr)

option(OPT_DIR "Compile in optional module" OFF)

if(OPT_DIR)
  message(${OPT_DIR})
endif()

option(RELEASE "Run in release mode" OFF)
if(RELEASE)
  message("RELEASE")
  ADD_DEFINITIONS(-DRELEASE)
else()
  message("DEBUG")
  ADD_DEFINITIONS(-DDEBUG)
endif()

option(RUN_TESTS "Run jnxlibc tests" OFF)
if(RUN_TESTS)
  execute_process(COMMAND cmake . WORKING_DIRECTORY test/unit)
  execute_process(COMMAND make WORKING_DIRECTORY test/unit)
  execute_process(COMMAND ./test_run WORKING_DIRECTORY test/unit RESULT_VARIABLE test_res)
  message("RET CODE IS => " ${test_res})
  if(${test_res} EQUAL 0)
    message("TESTS PASSED!")
  else()
    message(FATAL_ERROR "TESTS FAILED!")
  endif()
endif()
set(CMAKE_C_FLAGS "-Wall")
set(CMAKE_C_FLAGS_DEBUG "-g -rdynamic")
set(CMAKE_C_FLAGS_RELEASE "-O2")

IF(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64") 
  ADD_DEFINITIONS(-fPIC) 
ENDIF(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64")

add_library(jnxcs STATIC ${SOURCE}) 
add_library(jnxc SHARED ${SOURCE})
target_link_libraries(jnxc pthread)
target_link_libraries(jnxcs pthread)
install(TARGETS jnxcs DESTINATION ${INSTALL_PREFIX}/lib)
install(TARGETS jnxc DESTINATION ${INSTALL_PREFIX}/lib)
install(DIRECTORY jnxc_headers DESTINATION ${INSTALL_PREFIX}/include)
